# Legal Compliance

This document describes the legal safety mechanisms built into APKalypse to ensure generated applications do not infringe on intellectual property rights.

## Overview

APKalypse is designed from the ground up to be legally safe for creating applications that replicate **behavior** without copying **code**.

### Core Principle

> **We observe what an app does, not how it does it.**

The system extracts observable behaviors (screens, navigation, user flows) and generates completely new implementations using modern patterns and technologies.

---

## Compliance Guarantees

### 1. No Source Code Reuse

Decompiled source code is **NEVER**:
- Persisted to storage
- Passed to code generation agents
- Used as a template for generated code
- Stored in any form after analysis

**Implementation:**
```python
# In static_analysis/service.py
if self.config.compliance.purge_decompiled_after_analysis:
    await self._cleanup()  # Deletes all temp directories
```

### 2. Transient Analysis Only

Decompiled artifacts are:
- Extracted to temporary directories
- Used only for structural analysis
- Deleted immediately after analysis completes

**What is extracted:**
- AndroidManifest.xml content (parsed into structured data)
- Layout file structure (element types and IDs only)
- String resources (for understanding UI text)
- Library detection (by package name patterns)

**What is NOT extracted or stored:**
- Java/Kotlin source code
- Smali bytecode
- Business logic implementations
- Algorithm implementations

### 3. Similarity Detection

Generated code is checked against patterns that would indicate copying:

**Suspicious Patterns Detected:**
```python
SUSPICIOUS_PATTERNS = [
    r'// This code was generated by \w+',
    r'// Auto-generated from',
    r'// Decompiled with',
    r'/\* jadx \*/',
    r'/\* JADX',
    r'// Procyon decompiler',
    r'// CFR decompiler',
]
```

**Similarity Threshold:**
- Default: 30% maximum similarity
- Configurable via `B2B_COMPLIANCE_SIMILARITY_THRESHOLD`
- Exceeding threshold triggers compliance violation

### 4. Audit Trail

Complete provenance tracking for all artifacts:

**Input Tracking:**
- SHA-256 hash of original APK
- Timestamp of ingestion
- Source URL (if from Play Store)

**Output Tracking:**
- SHA-256 hash of each generated file
- Pipeline run ID
- Agent invocation records

**Compliance Report:**
```python
class ComplianceReport(BaseModel):
    report_id: str
    run_id: str
    created_at: datetime
    
    passed: bool
    violations: list[ComplianceViolation]
    
    artifacts_checked: int
    max_similarity_found: float
    
    input_hashes: dict[str, str]   # APK hash
    output_hashes: dict[str, str]  # All generated files
```

### 5. Behavioral Focus

The system extracts only user-facing behaviors:
- Screen layouts and navigation
- User interaction patterns
- Data display patterns
- Error handling patterns

It does **NOT** extract:
- Business logic implementations
- API communication details (only schema shapes)
- Authentication mechanisms
- Cryptographic implementations
- Proprietary algorithms

---

## Compliance Guard Service

The `ComplianceGuard` service runs as the final pipeline stage.

### Checks Performed

#### 1. Suspicious Pattern Detection

Scans all generated code for decompiler watermarks:

```python
async def check_suspicious_content(
    self,
    content: str,
    artifact_path: str,
) -> list[ComplianceViolation]:
    patterns_found = self._check_suspicious_patterns(content)
    # Returns violations for each pattern found
```

#### 2. Source Similarity Analysis

Compares generated code against decompiled samples:

```python
async def check_artifact_similarity(
    self,
    generated_content: str,
    decompiled_samples: list[str],
    artifact_path: str,
) -> tuple[float, list[ComplianceViolation]]:
    for sample in decompiled_samples:
        similarity = self._calculate_similarity(
            generated_content, sample
        )
        if similarity > threshold:
            # Raise violation
```

**Normalization for comparison:**
- Remove all comments
- Remove whitespace
- Remove string literals (focus on structure)
- Convert to lowercase

#### 3. Persisted Source Detection

Verifies no decompiled artifacts remain in storage:

```python
async def verify_no_source_persisted(
    self,
    storage_prefix: str,
) -> list[ComplianceViolation]:
    # Check for .smali, .jadx, .class files
    # Check for smali/, jadx-out/, decompiled/ directories
```

### Violation Types

| Rule ID | Severity | Description |
|---------|----------|-------------|
| `SOURCE_SIMILARITY` | Critical | Generated code too similar to original |
| `SUSPICIOUS_PATTERN` | Warning | Decompiler watermark detected |
| `SOURCE_PERSISTED` | Critical | Decompiled files found in storage |

### Blocking Mode

When `B2B_COMPLIANCE_STRICT=true`:
- Critical violations raise `ComplianceViolationError`
- Pipeline execution is halted
- Compliance report is preserved for audit

```python
if not passed and self.config.block_on_violation:
    raise ComplianceViolationError(
        message="Compliance check failed",
        rule_id="COMPLIANCE_BLOCK",
        violation_type="critical",
        context={"violations": violations},
    )
```

---

## Agent Safety

All AI agents are designed with legal safety in mind.

### Input Sanitization

Agents receive only:
- Behavioral observations
- Structural summaries
- Semantic descriptions

Agents **never** receive:
- Decompiled source code
- Original implementations
- Bytecode or smali

### Example: What the Spec Agent Sees

```python
# Agent input (sanitized)
{
    "screens_summary": [
        {"id": "screen_0", "name": "LoginScreen", "elements": 5},
        {"id": "screen_1", "name": "HomeScreen", "elements": 12},
    ],
    "user_intents": [
        {"name": "Login", "description": "User authentication"},
        {"name": "Browse", "description": "View content"},
    ],
    "navigation_flows": [
        {"from": "screen_0", "to": "screen_1", "action": "Tap login button"},
    ],
}

# Agent NEVER sees:
# - Original login implementation
# - Password hashing code
# - API authentication logic
```

### Prompt Guidelines

Agent prompts explicitly instruct:
- Generate fresh, original code
- Use modern patterns (Compose, Coroutines, Hilt)
- Do not attempt to recreate original implementation
- Focus on behavioral equivalence, not code similarity

---

## Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `B2B_COMPLIANCE_STRICT` | Block on violations | `true` |
| `B2B_COMPLIANCE_SIMILARITY_THRESHOLD` | Max similarity | `0.30` |
| `B2B_COMPLIANCE_PURGE_DECOMPILED` | Delete after analysis | `true` |

### Configuration Class

```python
class ComplianceConfig(BaseModel):
    block_on_violation: bool = True
    max_source_similarity_threshold: float = 0.30
    purge_decompiled_after_analysis: bool = True
```

---

## Audit and Reporting

### Compliance Report Location

Reports are stored at:
```
compliance/{run_id}/compliance_report.json
```

### Report Contents

```json
{
    "report_id": "abc123",
    "run_id": "def456",
    "created_at": "2024-01-15T10:30:00Z",
    
    "passed": true,
    "violations": [],
    "warnings": [],
    
    "artifacts_checked": 15,
    "source_similarity_checks": 0,
    "max_similarity_found": 0.0,
    
    "input_hashes": {
        "apk": "sha256:abc..."
    },
    "output_hashes": {
        "app/src/main/kotlin/.../MainActivity.kt": "sha256:def...",
        "app/src/main/kotlin/.../HomeScreen.kt": "sha256:ghi..."
    }
}
```

### Retrieving Reports

```python
from APKalypse.services.compliance import ComplianceGuard

guard = ComplianceGuard(storage)
report = await guard.audit_run(run_id)

if report:
    print(f"Passed: {report.passed}")
    print(f"Violations: {len(report.violations)}")
```

---

## Legal Considerations

### What This System Does

✅ **Allowed:**
- Observe publicly visible app behavior
- Document user interface patterns
- Generate equivalent functionality from scratch
- Use industry-standard patterns and libraries

### What This System Avoids

❌ **Prevented:**
- Copying or adapting original source code
- Extracting trade secrets or algorithms
- Bypassing technical protection measures
- Storing or distributing decompiled code

### Recommendations

1. **Review Generated Code**: Always review generated code before production use
2. **Legal Counsel**: Consult legal counsel for specific use cases
3. **License Verification**: Verify licenses of analyzed applications
4. **Documentation**: Keep compliance reports for audit purposes

---

## Best Practices

### 1. Enable Strict Mode

Always run with strict compliance:
```bash
export B2B_COMPLIANCE_STRICT=true
```

### 2. Review Similarity Scores

Monitor `max_similarity_found` in reports:
- `< 10%`: Excellent, no concern
- `10-20%`: Normal, coincidental patterns
- `20-30%`: Review generated code
- `> 30%`: Investigate immediately

### 3. Keep Audit Trails

Store compliance reports:
```python
# After pipeline completion
report_path = f"audits/{run_id}/compliance.json"
await storage.store_model(report_path, compliance_report)
```

### 4. Regular Audits

Periodically review:
- All compliance reports
- Any warnings generated
- Similarity trends over time

---

## Troubleshooting

### Violation: SOURCE_SIMILARITY

**Cause:** Generated code too similar to original

**Solutions:**
1. Review the specific file flagged
2. Ensure agents are not receiving decompiled code
3. Check for template issues in code generation
4. Regenerate with different prompts

### Violation: SUSPICIOUS_PATTERN

**Cause:** Decompiler watermark in output

**Solutions:**
1. Check if code was accidentally copied
2. Verify agent prompts don't include original code
3. Review agent input preparation logic

### Violation: SOURCE_PERSISTED

**Cause:** Decompiled files found in storage

**Solutions:**
1. Enable `purge_decompiled_after_analysis`
2. Check temp directory cleanup
3. Verify storage cleanup in static analysis service

---

## Summary

APKalypse implements comprehensive legal safeguards:

| Layer | Protection |
|-------|------------|
| **Analysis** | Transient processing, immediate cleanup |
| **Agents** | Sanitized inputs, no source code exposure |
| **Generation** | Fresh implementation from specifications |
| **Verification** | Similarity detection, pattern checking |
| **Audit** | Complete provenance tracking |

These mechanisms ensure that generated applications are legally safe, original implementations that replicate behavior without copying code.
